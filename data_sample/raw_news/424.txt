WASHINGTON ― Republicans failed to come up with the votes Friday to pass a major piece of their domestic policy agenda, with a farm bill rewrite dramatically going down on the House floor after a number of conservatives made a last-minute decision to oppose the legislation.

The bill, which fell short 198-213 with 30 Republicans voting no and no Democrats voting yes, had shaky support all week, but it had looked like it could get just enough votes Friday morning after House Freedom Caucus leaders appeared to be close to a deal on immigration with GOP leaders and moderates.

By the time the vote was called, however, conservative leaders in the Freedom Caucus said not enough progress had been made on the compromise, and a key number of them joined about a dozen moderate Republicans to sink the bill. (House Speaker Paul Ryan (R-Wis.) also ended up voting against the bill for procedural purposes of bringing the bill back up.)

The Freedom Caucus had withheld its support of the farm bill all week as a point of leverage over immigration, as Republicans sign a discharge petition for a vote on a slate of immigration proposals with the intention of passing a proposal that almost all Democrats would support.

Conservatives initially believed they could stymie the discharge petition ― which is used to bring a piece of legislation to the floor when leaders refuse to give a vote to a bill with majority support ― by holding a vote on part of the legislative vehicle for the petition itself. But it became clear later in the week that their plan wouldn’t actually stop the petition.

So the Freedom Caucus shifted its focus toward working out an agreement on an actual immigration bill that could pass muster with GOP moderates and conservatives.

Republican leaders tried to work out that deal with the Freedom Caucus, and conservatives said Friday morning that they felt there’d been significant progress. Minutes before the final vote was called, as the House voted on amendments to the farm bill, leaders were still negotiating with the Freedom Caucus to try and find some agreement on immigration that would push the farm bill over the top.

But that deal never quite materialized, and just before the final vote came, leaders decided their best chance of passing the bill was to abandon talking with the Freedom Caucus and work individual members to try and pressure them to flip.

Ultimately, leaders didn’t get close enough, and the bill fell short by a number of votes. (Leadership would have had to flip eight Republicans to pass the bill.)

Leaders can still pick up the bill next week. And under House rules, a motion to reconsider the bill would have to be brought up within two legislative days, though Republicans could always bring up the bill under a separate rule at any time. This likely isn’t the end for this farm bill.

But Friday’s failure is an embarrassing defeat for Republican leaders, and it leaves immigration negotiations in a strange place. Republicans who wanted the farm bill may now be less inclined to support a hard-line immigration bill, and more inclined to sign on to the discharge petition. And Freedom Caucus members have now taken a firm line that they won’t support the farm bill for vague immigration promises.

Conservatives were lukewarm to the farm bill as it stood. The bill includes significant amounts of farm subsidies for rural businesses and reauthorizes the Supplemental Nutrition Assistance Program to get buy-in from more urban lawmakers. Democrats and moderate Republicans opposed the bill on the grounds that the SNAP cuts it included were too drastic.

The bill would require a greater number of adults receiving SNAP benefits to work at least 20 hours per week or enroll in training. The stricter requirement would therefore reduce food stamp enrollment ― which has already been on a steady decline ― by an additional 1.2 million over 10 years, according to the Congressional Budget Office.

Speaker of the House Paul Ryan (R-Wis.) holds his weekly press conference in the Capitol on May 17. Bill Clark via Getty Images

Echoing businesses in their districts, Ryan and other Republicans said denying benefits to some adults would make it easier for companies to hire ― which is another way of saying the bill would help keep wages down.

There’s no way to reduce welfare enrollment without being “harsh,” Rep. Glenn Grothman (R-Wis.) said during a committee session on Wednesday. Grothman supported even harsher SNAP reforms and added that some welfare recipients provide “a bad role model for their children.”

Rep. Alcee Hastings (D-Fla.) responded, “Some of the best mothers in the world are poor mothers and some of the worst mothers in the world are rich mothers.”

The bill directly targets poor parents. Under current law, adults 18-49 who don’t have minor children are subject to the work requirement, which is waived in many areas due to above-average unemployment. The legislation would make the waivers more difficult for states to obtain, and would broaden the requirement to people in their 50s and parents of minor children older than 6. The bill would also create a new training program in which SNAP recipients could enroll for a limited time in order to meet the requirement.

While the bill makes it more difficult for some people to obtain SNAP benefits, certain farmers and their relatives would become newly eligible for farm subsidies that can add up to $125,000 annually per person. One provision would exempt certain types of farm businesses from an income limit that disallows married households from obtaining subsidies if their annual income exceeds $1.8 million.

Republicans also defeated a bipartisan amendment that would have reformed the sugar program, which benefits sugar producers by guaranteeing a minimum price for the commodity. Sugar welfare is the most reviled agribusiness giveaway in the farm bill. Unlike other farm programs, it has well-financed opposition from food makers that use sugar as an ingredient.

But even this small effort to rein in farm subsidies was easily defeated on the House floor Thursday. Rep. Ted Yoho (R-Fla.) said the amendment would only “line the pockets of these multinational soda pop makers and candy makers.”

Nothing in the bill can become law unless it can also pass the Senate, where agriculture committee Chairman Pat Roberts (R-Kan.) has already said he won’t support anything that can’t win acceptance from at least some of his Democratic colleagues.